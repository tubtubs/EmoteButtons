
NUM_ICONS_SHOWN = 20;
NUM_ICONS_PER_ROW = 5;
NUM_ICON_ROWS = 4;
ICON_ROW_HEIGHT = 36;


--Make druid abilities the default category, for now
IP_CATEGORY_SELECTED = 2
IP_SUBCATEGORY_SELECTED = 1

IP_CATEGORY_ABILITY = 1
IP_CATEGORY_ACHIVEMENTS = 2
IP_CATEGORY_CONSUME = 3
IP_CATEGORY_EQUIPMENT = 4
IP_CATEGORY_MISC = 8
IP_CATEGORY_SPELLS = 5
IP_CATEGORY_TRADES = 6
IP_CATEGORY_WEAPONS = 7

IP_ABILITY_ICONS = {
    {
        icons = IP_icons_abilities_druid,
        size = IP_len_icons_abilities_druid
    },
    {
        icons = IP_icons_abilities_hunter,
        size = IP_len_icons_abilities_hunter
    },
    { 
        icons = IP_icons_abilities_mage,
        size = IP_len_icons_abilities_mage
    },
    {
        icons = IP_icons_abilities_misc,
        size = IP_len_icons_abilities_misc
    },
    {
        icons = IP_icons_abilities_mounts,
        size = IP_len_icons_abilities_mounts
    },
    {
        icons = IP_icons_abilities_paladin,
        size = IP_len_icons_abilities_paladin
    },
    {
        icons = IP_icons_abilities_rogue,
        size = IP_len_icons_abilities_rogue
    },
    {
        icons = IP_icons_abilities_shaman,
        size = IP_len_icons_abilities_shaman
    },
    {
        icons = IP_icons_abilities_warlock,
        size = IP_len_icons_abilities_warlock
    },
    {
        icons = IP_icons_abilities_warrior,
        size = IP_len_icons_abilities_warrior
    }
}

IP_CONSUME_ICONS = {
    {
        icons = IP_icons_consume_drinks,
        size = IP_len_icons_consume_drinks
    },
    {
        icons = IP_icons_consume_food,
        size = IP_len_icons_consume_food
    },
    {
        icons = IP_icons_consume_potions,
        size = IP_len_icons_consume_potions
    }
}

IP_EQUIPMENT_ICONS = {
    {
        icons = IP_icons_equipment_belts,
        size = IP_len_icons_equipment_belts
    },
    {
        icons = IP_icons_equipment_boots,
        size = IP_len_icons_equipment_boots,
    },
    {
        icons = IP_icons_equipment_bracersgauntlets,
        size = IP_len_icons_equipment_bracersgauntlets
    },
    {
        icons = IP_icons_equipment_capes,
        size = IP_len_icons_equipment_capes
    },
    {
        icons = IP_icons_equipment_chest,
        size = IP_len_icons_equipment_chest
    },
    {
        icons = IP_icons_equipment_headgear,
        size = IP_len_icons_equipment_headgear
    },
    {
        icons = IP_icons_equipment_jewelry,
        size = IP_len_icons_equipment_jewelry
    },
    {
        icons = IP_icons_equipment_misc,
        size = IP_len_icons_equipment_misc
    },
    {
        icons = IP_icons_equipment_offhand,
        size = IP_len_icons_equipment_offhand
    },
    {
        icons = IP_icons_equipment_pants,
        size = IP_len_icons_equipment_pants
    },
    {
        icons = IP_icons_equipment_shirttabard,
        size = IP_len_icons_equipment_shirttabard
    },
    {
        icons = IP_icons_equipment_shoulder,
        size = IP_len_icons_equipment_shoulder
    }

}

IP_ACHIEVEMENT_ICONS = {
    {
        icons = IP_icons_achievements,
        size = IP_len_icons_achievements
    }
}

IP_MISC_ICONS = {
    {
        icons = IP_icons_misc,
        size = IP_len_icons_misc
    }
}

IP_SPELLS_ICONS = {
    {
        icons = IP_icons_spells_arcane,
        size = IP_len_icons_spells_arcane
    },
    {
        icons = IP_icons_spells_deathknight,
        size = IP_len_icons_spells_deathknight
    },
    {
        icons = IP_icons_spells_fire,
        size = IP_len_icons_spells_fire
    },
    {
        icons = IP_icons_spells_frost,
        size = IP_len_icons_spells_frost
    },
    {
        icons = IP_icons_spells_holy,
        size = IP_len_icons_spells_holy
    },
    {
        icons = IP_icons_spells_misc,
        size = IP_len_icons_spells_misc
    },
    {
        icons = IP_icons_spells_nature,
        size = IP_len_icons_spells_nature
    },
    {
        icons = IP_icons_spells_shadow,
        size = IP_len_icons_spells_shadow
    },
    {
        icons = IP_icons_spells_shaman,
        size = IP_len_icons_spells_shaman
    },
}

IP_TRADE_ICONS = {
    { 
        icons = IP_icons_trade_alchemy,
        size = IP_len_icons_trade_alchemy
    },
    { 
        icons = IP_icons_trade_blacksmithing,
        size = IP_len_icons_trade_blacksmithing
    },
    { 
        icons = IP_icons_trade_elementals,
        size = IP_len_icons_trade_elementals
    },
    { 
        icons = IP_icons_trade_enchant,
        size = IP_len_icons_trade_enchant
    },
    { 
        icons = IP_icons_trade_eng,
        size = IP_len_icons_trade_eng
    },
    { 
        icons = IP_icons_trade_firstaid,
        size = IP_len_icons_trade_firstaid
    },
    { 
        icons = IP_icons_trade_fishing,
        size = IP_len_icons_trade_fishing
    },
    { 
        icons = IP_icons_trade_herbalism,
        size = IP_len_icons_trade_herbalism
    },
    { 
        icons = IP_icons_trade_inscription,
        size = IP_len_icons_trade_inscription
    },
    { 
        icons = IP_icons_trade_jewelcrafting,
        size = IP_len_icons_trade_jewelcrafting
    },
    { 
        icons = IP_icons_trade_leatherworking,
        size = IP_len_icons_trade_leatherworking
    },
    { 
        icons = IP_icons_trade_mining,
        size = IP_len_icons_trade_mining
    },
    { 
        icons = IP_icons_trade_misc,
        size = IP_len_icons_trade_misc
    },
    { 
        icons = IP_icons_trade_tailoring,
        size = IP_len_icons_trade_tailoring
    },
}

IP_WEAPON_ICONS = {
    {
        icons = IP_icons_weapon_axe,
        size = IP_len_icons_weapon_axe
    },
    {
        icons = IP_icons_weapon_dagger,
        size = IP_len_icons_weapon_dagger
    },
    {
        icons = IP_icons_weapon_fistweapon,
        size = IP_len_icons_weapon_fistweapon
    },
    {
        icons = IP_icons_weapon_mace,
        size = IP_len_icons_weapon_mace
    },
    {
        icons = IP_icons_weapon_misc,
        size = IP_len_icons_weapon_misc
    },
    {
        icons = IP_icons_weapon_polearm,
        size = IP_len_icons_weapon_polearm
    },
    {
        icons = IP_icons_weapon_ranged,
        size = IP_len_icons_weapon_ranged
    },
    {
        icons = IP_icons_weapon_staff,
        size = IP_len_icons_weapon_staff
    },
    {
        icons = IP_icons_weapon_sword,
        size = IP_len_icons_weapon_sword
    }
}

IP_ICONS = {
    IP_ABILITY_ICONS,
    IP_ACHIEVEMENT_ICONS,
    IP_CONSUME_ICONS,
    IP_EQUIPMENT_ICONS,
    IP_SPELLS_ICONS,
    IP_TRADE_ICONS,
    IP_WEAPON_ICONS,
    IP_MISC_ICONS
}

IP_ICONPATH = "Interface\\Icons\\"

NUM_CATEGORIES = 8
OKAY_FUNC = ""

--Can be called externally to get random icon
--Truncated tho, has path removed.
function IconPickerRandomIcon()
    cat = math.random(NUM_CATEGORIES)
    l = getn(IP_ICONS[cat])
    subcat = math.random(l)
    m = getn(IP_ICONS[cat][subcat].icons)
    return IP_ICONS[cat][subcat].icons[math.random(m)]
end

--Can be forced to draw externally
--icon to scroll to, can be blank
--text to fill in, can be blank
--must have a return function that takes icon,text
--anchor can be nil, will draw to center screen.
function IconPickerForceShow(icon,text,func,anchor)
    if IconPickerFrame:IsVisible() then
        IconPickerFrame:Hide();
    end
    OKAY_FUNC = func;
    if anchor ~= nil then
        IconPickerFrame:SetPoint(anchor.Point,anchor.RelativeTo,
            anchor.RelativePoint,anchor.x,anchor.y);
    else    
        IconPickerFrame:SetPoint("CENTER","UIParent","CENTER",0,0);
    end
    if icon ~= "" then
        IconPickerFindIcon(icon);
    end
    IconPickerFrame:Show();
    IconPickerEditBox:SetText(text);
end

function IconPickerRandomIconButton()
    cat = math.random(NUM_CATEGORIES)
    l = getn(IP_ICONS[cat])
    subcat = math.random(l)
    m = getn(IP_ICONS[cat][subcat].icons)
    IP_CATEGORY_SELECTED = cat;
    IP_SUBCATEGORY_SELECTED = subcat;
    found = math.random(m)
    if (math.mod(found,5) == 0 ) then
        offset = floor((found-1)/5)*36;
            innerIndex=5;
    else
        offset = floor(found/5)*36;
        innerIndex=math.mod(found,5); 
    end
    getglobal("IconPickerButton"..innerIndex):SetChecked(1);
    IconPickerFrame.selectedIcon = found;
    IconPickerFrame_Update();
    IconPickerScrollFrame:SetVerticalScroll(offset);
    IconPickerUncheckAllCategories()
    IconPickerCheckSelectedCategory()
end

function IconPickerFindIcon(icon)
    found = 0;
    for i, v in pairs (IP_ICONS) do
        for j,v in pairs (IP_ICONS[i]) do
            m = IP_ICONS[i][j].icons
            for k=1, getn(m) do
                if icon == m[k] then
                    IP_CATEGORY_SELECTED = i;
                    IP_SUBCATEGORY_SELECTED = j;
                    IconPickerFrame.selectedIcon=k;
                    found = k;
                    break; --exit early, giving first result.
                end
            end
            if found ~= 0 then
                break;
            end
        end
        if found ~= 0 then
            break;
        end
    end
    if (found ~= 0) then
		if (math.mod(found,5) == 0 ) then
			offset = floor((found-1)/5)*36;
				innerIndex=5;
		else
			offset = floor(found/5)*36;
			innerIndex=math.mod(found,5); 
		end
        getglobal("IconPickerButton"..innerIndex):SetChecked(1);
		IconPickerFrame.selectedIcon = found;
        IconPickerFrame_Update()
		IconPickerScrollFrame:SetVerticalScroll(offset);
    else
        DEFAULT_CHAT_FRAME:AddMessage(format("Could not find %s",icon))
	end
end

function IconPickerFrame_OnShow()
	PlaySound("igCharacterInfoOpen");
	IconPickerEditBox:ClearFocus();
	IconPickerOkayButton_Update();
    IconPickerFrame_Update();
    IconPickerUncheckAllCategories()
    IconPickerCheckSelectedCategory()
end

function IconPickerFrame_OnHide()
	IconPickerFrame:Hide();
    CloseDropDownMenus();
	PlaySound("igCharacterInfoClose");
end

function IconPickerButton_OnClick()
	IconPickerFrame.selectedIcon =  this:GetID() + (FauxScrollFrame_GetOffset(IconPickerScrollFrame) * NUM_ICONS_PER_ROW)
	IconPickerOkayButton_Update();
	IconPickerFrame_Update();
end

function IconPickerOkayButton_Update() 
	if ( IconPickerFrame.selectedIcon and IconPickerFrame.selectedIcon ~= 0 ) then
		IconPickerOkayButton:Enable();
	else
		IconPickerOkayButton:Disable();
	end
end

function IconPickerOkayButton_OnClick()
    n = IconPickerFrame.selectedIcon;
	cat = IP_CATEGORY_SELECTED;
    subcat = IP_SUBCATEGORY_SELECTED;
    l = IP_ICONS[cat][subcat].icons;
    icon = l[n];
    text = IconPickerEditBox:GetText();
    IconPickerFrame:Hide();
    OKAY_FUNC(icon,text);
end

function IconPickerFrame_Update()
    if IP_SUBCATEGORY_SELECTED == 0 then
        a = IP_ICONS[IP_CATEGORY_SELECTED][1]
	else
        a = IP_ICONS[IP_CATEGORY_SELECTED][IP_SUBCATEGORY_SELECTED]
    end
    numMacroIcons = a.size
    ico = a.icons
	local IconPickerIcon, IconPickerButton;
	local IconPickerOffset = FauxScrollFrame_GetOffset(IconPickerScrollFrame);
	local index;	
	-- Icon list
	for i=1, NUM_ICONS_SHOWN do
		IconPickerIcon = getglobal("IconPickerButton"..i.."Icon");
		IconPickerButton = getglobal("IconPickerButton"..i);
		index = (IconPickerOffset * NUM_ICONS_PER_ROW) + i;
		if ( index <= numMacroIcons ) then
			IconPickerIcon:SetTexture(IP_ICONPATH..ico[index]);
			IconPickerButton:Show();
		else
			IconPickerIcon:SetTexture("");
			IconPickerButton:Hide();
		end
		if ( index == IconPickerFrame.selectedIcon ) then
			IconPickerButton:SetChecked(1);
		else
			IconPickerButton:SetChecked(nil);
		end
	end	
	-- Scrollbar stuff
	FauxScrollFrame_Update(IconPickerScrollFrame, ceil(numMacroIcons / NUM_ICONS_PER_ROW) , NUM_ICON_ROWS, ICON_ROW_HEIGHT );
end

function IconPickerUncheckAllCategories()
    IconPickerAbilities:SetChecked(0);
    IconPickerAchievements:SetChecked(0);
    IconPickerConsumes:SetChecked(0);
    IconPickerEquipment:SetChecked(0);
    IconPickerMisc:SetChecked(0);
    IconPickerSpells:SetChecked(0);
    IconPickerTrades:SetChecked(0);
    IconPickerWeapons:SetChecked(0);
end

function IconPickerCheckSelectedCategory()
    if (IP_CATEGORY_SELECTED == IP_CATEGORY_ABILITY) then 
        IconPickerAbilities:SetChecked(1);
    elseif (IP_CATEGORY_SELECTED == IP_CATEGORY_ACHIVEMENTS) then 
        IconPickerAchievements:SetChecked(1);
    elseif (IP_CATEGORY_SELECTED == IP_CATEGORY_CONSUME) then 
        IconPickerConsumes:SetChecked(1);
    elseif (IP_CATEGORY_SELECTED == IP_CATEGORY_EQUIPMENT) then 
        IconPickerEquipment:SetChecked(1);
    elseif (IP_CATEGORY_SELECTED == IP_CATEGORY_MISC) then 
        IconPickerMisc:SetChecked(1);
    elseif (IP_CATEGORY_SELECTED == IP_CATEGORY_SPELLS) then 
        IconPickerSpells:SetChecked(1);
    elseif (IP_CATEGORY_SELECTED == IP_CATEGORY_TRADES) then 
        IconPickerTrades:SetChecked(1);
    elseif (IP_CATEGORY_SELECTED == IP_CATEGORY_WEAPONS) then 
        IconPickerWeapons:SetChecked(1);
    end
end

function IconPickerAbilitiesDropDown_OnShow()
	for i=1, getn(IP_icons_abilties_categories) do
		info = {};
		info.text       = IP_icons_abilties_categories[i];
		info.value      = i;
        IconPickerAbilities.checked = false;
		if (IP_CATEGORY_SELECTED == IP_CATEGORY_ABILITY
            and IP_SUBCATEGORY_SELECTED == i) then
			info.checked =true;
		else
			info.checked=false;
		end
		info.func =  function() 

            IP_CATEGORY_SELECTED = IP_CATEGORY_ABILITY;
            IP_SUBCATEGORY_SELECTED = this.value;
            IconPickerUncheckAllCategories()
            IconPickerCheckSelectedCategory()
            IconPickerScrollFrame:SetVerticalScroll(0);
            IconPickerFrame.selectedIcon =0;
            IconPickerOkayButton_Update()
            IconPickerFrame_Update();
		end
		UIDropDownMenu_AddButton(info);
	end
end

function IconPickerAbilities_OnClick()
	ToggleDropDownMenu(1, nil, IconPickerAbilities, IconPickerAbilities, 0, 0);
    IconPickerUncheckAllCategories()
    IconPickerCheckSelectedCategory()
end

function IconPickerAchievements_OnClick()
    IP_CATEGORY_SELECTED = IP_CATEGORY_ACHIVEMENTS;
    IP_SUBCATEGORY_SELECTED = 1;
    IconPickerUncheckAllCategories()
    IconPickerCheckSelectedCategory()
    IconPickerScrollFrame:SetVerticalScroll(0);
    IconPickerFrame.selectedIcon =0;
    IconPickerOkayButton_Update()
    IconPickerFrame_Update();
    CloseDropDownMenus()
end

function IconPickerConsumesDropDown_OnShow()
    for i=1, getn(IP_icons_consume_categories) do
		info = {};
		info.text       = IP_icons_consume_categories[i];
		info.value      = i;
		if (IP_CATEGORY_SELECTED == IP_CATEGORY_CONSUME
            and IP_SUBCATEGORY_SELECTED == i) then
			info.checked =true;
		else
			info.checked=false;
		end
		info.func =  function() 
            IP_CATEGORY_SELECTED = IP_CATEGORY_CONSUME;
            IP_SUBCATEGORY_SELECTED = this.value;	
            IconPickerUncheckAllCategories()
            IconPickerCheckSelectedCategory()
            IconPickerScrollFrame:SetVerticalScroll(0);
            IconPickerFrame.selectedIcon =0;
            IconPickerOkayButton_Update()
            IconPickerFrame_Update();
		end
		UIDropDownMenu_AddButton(info);
	end
end

function  IconPickerConsumes_OnClick()
	ToggleDropDownMenu(1, nil, IconPickerConsumes, IconPickerConsumes, 0, 0);
    IconPickerUncheckAllCategories()
    IconPickerCheckSelectedCategory()
end

function IconPickerEquipmentDropDown_OnShow()
    for i=1, getn(IP_icons_equipment_categories) do
		info = {};
		info.text       = IP_icons_equipment_categories[i];
		info.value      = i;
		if (IP_CATEGORY_SELECTED == IP_CATEGORY_EQUIPMENT
            and IP_SUBCATEGORY_SELECTED == i) then
			info.checked =true;
		else
			info.checked=false;
		end
		info.func =  function() 
            IP_CATEGORY_SELECTED = IP_CATEGORY_EQUIPMENT;
            IP_SUBCATEGORY_SELECTED = this.value;	
            IconPickerUncheckAllCategories()
            IconPickerCheckSelectedCategory()
            IconPickerScrollFrame:SetVerticalScroll(0);
            IconPickerFrame.selectedIcon =0;
            IconPickerOkayButton_Update()
            IconPickerFrame_Update();
		end
		UIDropDownMenu_AddButton(info);
	end
end

function  IconPickerEquipment_OnClick()
    ToggleDropDownMenu(1, nil, IconPickerEquipment, IconPickerEquipment, 0, 0);
        IconPickerUncheckAllCategories()
        IconPickerCheckSelectedCategory()
end

function IconPickerMisc_OnClick()
    IP_CATEGORY_SELECTED = IP_CATEGORY_MISC;
    IP_SUBCATEGORY_SELECTED = 1;
    IconPickerUncheckAllCategories()
    IconPickerCheckSelectedCategory()
    IconPickerScrollFrame:SetVerticalScroll(0);
    IconPickerFrame.selectedIcon =0;
    IconPickerOkayButton_Update()
    IconPickerFrame_Update();
    CloseDropDownMenus()
end

function IconPickerSpellsDropDown_OnShow()
    for i=1, getn(IP_icons_spells_categories) do
		info = {};
		info.text       = IP_icons_spells_categories[i];
		info.value      = i;
		if (IP_CATEGORY_SELECTED == IP_CATEGORY_SPELLS
            and IP_SUBCATEGORY_SELECTED == i) then
			info.checked =true;
		else
			info.checked=false;
		end
		info.func =  function() 
            IP_CATEGORY_SELECTED = IP_CATEGORY_SPELLS;
            IP_SUBCATEGORY_SELECTED = this.value;	
            IconPickerUncheckAllCategories()
            IconPickerCheckSelectedCategory()
            IconPickerScrollFrame:SetVerticalScroll(0);
            IconPickerFrame.selectedIcon =0;
            IconPickerOkayButton_Update()
            IconPickerFrame_Update();
		end
		UIDropDownMenu_AddButton(info);
	end
end

function IconPickerSpells_OnClick()
    ToggleDropDownMenu(1, nil, IconPickerSpells, IconPickerSpells, 0, 0);
    IconPickerUncheckAllCategories()
    IconPickerCheckSelectedCategory()
end

function IconPickerTradesDropDown_OnShow()
    for i=1, getn(IP_icons_trades_categories) do
		info = {};
		info.text       = IP_icons_trades_categories[i];
		info.value      = i;
		if (IP_CATEGORY_SELECTED == IP_CATEGORY_TRADES
            and IP_SUBCATEGORY_SELECTED == i) then
			info.checked =true;
		else
			info.checked=false;
		end
		info.func =  function() 
            IP_CATEGORY_SELECTED = IP_CATEGORY_TRADES;
            IP_SUBCATEGORY_SELECTED = this.value;
            IconPickerUncheckAllCategories()
            IconPickerCheckSelectedCategory()
            IconPickerScrollFrame:SetVerticalScroll(0);
            IconPickerFrame.selectedIcon =0;
            IconPickerOkayButton_Update()
            IconPickerFrame_Update();
		end
		UIDropDownMenu_AddButton(info);
	end
end

function IconPickerTrades_OnClick()
    ToggleDropDownMenu(1, nil, IconPickerTrades, IconPickerTrades, 0, 0);
    IconPickerUncheckAllCategories()
    IconPickerCheckSelectedCategory()
end

function IconPickerWeaponsDropDown_OnShow()
    for i=1, getn(IP_icons_weapon_categories) do
		info = {};
		info.text       = IP_icons_weapon_categories[i];
		info.value      = i;
		if (IP_CATEGORY_SELECTED == IP_CATEGORY_WEAPONS
            and IP_SUBCATEGORY_SELECTED == i) then
			info.checked =true;
		else
			info.checked=false;
		end
		info.func =  function() 
            IP_CATEGORY_SELECTED = IP_CATEGORY_WEAPONS;
            IP_SUBCATEGORY_SELECTED = this.value;	
            IconPickerUncheckAllCategories()
            IconPickerCheckSelectedCategory()
            IconPickerScrollFrame:SetVerticalScroll(0);
            IconPickerFrame.selectedIcon =0;
            IconPickerOkayButton_Update()
            IconPickerFrame_Update();
		end
		UIDropDownMenu_AddButton(info);
	end
end

function IconPickerWeapons_OnClick() 
    ToggleDropDownMenu(1, nil, IconPickerWeapons, IconPickerWeapons, 0, 0);
    IconPickerUncheckAllCategories()
    IconPickerCheckSelectedCategory()
end